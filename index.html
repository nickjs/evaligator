<html>
<head>
  <title>Evaligator</title>
  <link rel="stylesheet" type="text/css" href="style.css" title="default">
  <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="header">
    <img class="omnom" src="img/omnom.png">
    <div class="pageTitle"><b>evaligator</b>.js</div>
      <ul id="nav">
        <li><a href='index.html'>overview</a></li>
        <li><a href='#'>load an example</a>
          <ul>
            <li><a href="#" id="ex1" onClick="Editor.loadExample(1);">variables</a></li>
            <li><a href="#" id="ex1" onClick="Editor.loadExample(2);">loops</a></li>
            <li><a href="#" id="ex1" onClick="Editor.loadExample(3);">functions</a></li>
          </ul>
        </li>
    </ul>
  </div>
    
  <a href="https://github.com/nciagra/evaligator">
  <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/assets.github.com/img/7afbc8b248c68eb468279e8c17986ad46549fb71/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub">
  </a>

  <div class="textChunk">
    <h1>What is this?</h1>
    <p>CoffeeScript thingamalligator that noms your javascript code as you type it, and evaluates it.

    <p>To get things going, start typing some code in the right editor below. Or load one of the examples. <br/>
    And then feed the evaligator.</p>

    <h1>Ok, you play with it:</h1>
  </div>

  <div id="editor"></div>

  <div id="parameter-debug-input" style="display:hidden"></div>


  <div class="textChunk">
    <h1>Now, the important bits</h1>
    <p>slapshoddily assembled by <a href="http://twitter.com/nciagra">nick</a> and <a href="http://dinculescu.com">monica</a></p>
    <p>lovingly stolen from all the worried dreams of <a href="http://worrydream.com">bret victor</a></p>
    <p>begrudgingly using language.js from <a href="http://github.com/tolmasky">francisco tolmasky</a></p>
  </div>


 <div id="transmogrifier-debug-output" style="background-color:#fff;font-family:Menlo"></div>

  </style>
  <!-- <div id="visualismifier"></div> -->
  <script src="ace/ace.js" type="text/javascript"></script>
  <script src="ace/theme-monokai-uncompressed.js" type="text/javascript"></script>
  <script src="lib/parser.js" type="text/javascript"></script>
  <script src="lib/coffee-script.js" type="text/javascript"></script>
  <script src="evaligator.coffee" type="text/coffeescript"></script>

  <script type="text/coffeescript">
    if window.DEBUG_THE_EVALIGATOR = window.location.hash.toLowerCase().indexOf('debug') isnt -1
      document.getElementById('parameter-debug-input').style.display = 'block'

    paramCacheOfDoom = []
    window.ASK_ME_FOR_ALL_MY_PARAMETERS = (me) ->
      container = document.getElementById('parameter-debug-input')
      container.innerHTML = ''

      for theFunction, i in me.allFunctionParameters()
        elem = document.createElement 'div'
        elem.innerHTML = "Function #{i} -> "
        for param in theFunction
          span = document.createElement 'span'
          span.innerHTML = "#{param.identifier}:"
          elem.appendChild span

          paramElem = document.createElement 'input'
          paramElem.placeholder = param.identifier
          paramElem.value = param.value
          paramElem.style.fontSize = '1.2em'
          paramElem.style.width = '80px'
          do (param, paramElem) ->
            paramElem.onkeyup = ->
              paramCacheOfDoom.push valueArguments = [param.lineNumber, param.identifier, (new Function("try { return #{paramElem.value}; } catch(e) {}"))()]
              me.assignValue.apply me, valueArguments
              Editor.refreshViewer()
          elem.appendChild paramElem
        container.appendChild elem

      window.ALL_YOUR_PARAMETERS_IS_BELONG_TO_ME = (me) ->
        for valueArguments in paramCacheOfDoom
          me.assignValueIfIdentifierExists.apply me, valueArguments

    class EditorView
      EditSession = require('ace/edit_session').EditSession
      UndoManager = require('ace/undomanager').UndoManager
      Split = require('ace/split').Split
      Mode = require('ace/mode/javascript').Mode

      currentViewerAnnotations = []

      constructor: (node) ->
        @split = new Split node, require('ace/theme/monokai'), 2

        workerlessMode = new Mode
        workerlessMode.createWorker = ->

        @editor = @split.getEditor(0)
        @editor.getSession().setMode new Mode
        @editor.getSession().setUndoManager new UndoManager

        @viewer = @split.getEditor(1)
        @viewer.getSession().setMode workerlessMode
        @viewer.setHighlightActiveLine no
        @viewer.setShowPrintMargin no
        @viewer.setReadOnly yes

        @editor.focus()

        @codeParser = new SourceCodeParser

        
        window.addEventListener 'mouseup', (e) -> 
          if e.target.title is 'Function definition'
            e.stopPropagation() 
            alert("you clicked a function definition on line " + e.target.innerHTML)

        window.addEventListener 'resize', =>
          @split.resize()

        @editor.getSession().on 'change', =>
          theHopefullyNotArbitraryTextThatWasTyped = @editor.getSession().getDocument().getValue()
        
          treeIsValid = @codeParser.parseThemSourceCodes theHopefullyNotArbitraryTextThatWasTyped, true
          if (treeIsValid)
              @refreshViewer()

        @viewer.getSession().on 'change', (e)=>
          

      displayViewerAnnotations: () ->
        newAnnotation = { 
                row: @editor.getCursorPosition().row, 
                column: @editor.getCursorPosition().column, 
                text: "Function definition", 
                type: "info" 
        }

        # node: setAnnotations clears everything first. and randomly, and i hate it
        currentViewerAnnotations.push(newAnnotation)

        @viewer.getSession().setAnnotations(currentViewerAnnotations)


      refreshViewer: () ->
        @codeParser.transmogrifier.run()
        @viewer.getSession().setValue @codeParser.displayValue()
        @displayViewerAnnotations()

      loadExample: (whichExample) ->
        # initialize the editor with some random stuff
        example1 = 
        """
          var a = 0;
          var b = a;

          var arr = ['tuna', 'fish'];
          var allTheOddThings = '';

          for (var i = 0; i < 2 * arr.length; i++){
               b += i;
               if (b % 2 != 0){
                  allTheOddThings += b + ', ';
               }
          }
        """
        example2 = 
        """
        var a = 0;
          for (var i = 0; i < 30; i++){
              a = i;
          }
          a++;
          var b = 0;
          while (a < 100){
              b++
          }
        """

        example3 = 
        """
        var a = 0;
        var f = function(x, y){
          a += x;
        }
        """

        switch whichExample
            when 1 then @editor.getSession().setValue example1
            when 2 then @editor.getSession().setValue example2
            when 3 then @editor.getSession().setValue example3

    window.Editor = new EditorView document.getElementById('editor')
</script>

</body>
</html>
